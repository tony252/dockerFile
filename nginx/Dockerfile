# ================================
# é˜¶æ®µ 1ï¼šæ„å»ºé˜¶æ®µ - ç¼–è¯‘ Nginxï¼ˆå¯ç”¨ stream æ¨¡å—ï¼‰
# ================================
FROM alpine:latest AS builder

# è®¾ç½®ç‰ˆæœ¬å˜é‡
ENV NGINX_VERSION=1.26.2 \
    PREFIX=/usr/local/nginx

# æ›´æ¢ä¸ºé˜¿é‡Œäº‘é•œåƒæºï¼ˆè§£å†³å›½å†…ç½‘ç»œé—®é¢˜ï¼‰
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–ï¼ˆå…³é”®ï¼šåŒ…å« linux-headersï¼‰
RUN apk add --no-cache \
    gcc \
    g++ \
    make \
    autoconf \
    libc-dev \
    linux-headers \
    pcre-dev \
    zlib-dev \
    openssl-dev \
    wget \
    tar \
    ca-certificates

# ä¸‹è½½å¹¶è§£å‹ Nginx æºç ï¼ˆç¦ç”¨æƒé™è¿˜åŸï¼‰
RUN echo "ğŸ“¥ ä¸‹è½½ Nginx ${NGINX_VERSION}..." && \
    wget -q https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz && \
    echo "ğŸ“¦ è§£å‹ä¸­..." && \
    tar -xzf nginx-${NGINX_VERSION}.tar.gz --no-same-permissions -C / && \
    rm -f nginx-${NGINX_VERSION}.tar.gz && \
    echo "âœ… è§£å‹å®Œæˆ"

# è¿›å…¥æºç ç›®å½•å¹¶é…ç½®
RUN echo "âš™ï¸  é…ç½® Nginx..." && \
    cd /nginx-${NGINX_VERSION} && \
    ./configure \
        --prefix=${PREFIX} \
        --with-stream \
        --with-stream_ssl_module \
        --with-http_ssl_module \
        --with-http_v2_module \
        --with-http_realip_module \
        --with-http_gzip_static_module \
        --with-http_stub_status_module \
        --with-threads \
        --with-file-aio \
        --with-compat \
        --without-http_uwsgi_module \
        --without-http_scgi_module \
        --without-http_fastcgi_module \
    && \
    echo "âœ… é…ç½®å®Œæˆ"

# ç¼–è¯‘å¹¶å®‰è£…
RUN echo "ğŸ”§ å¼€å§‹ç¼–è¯‘..." && \
    cd /nginx-${NGINX_VERSION} && \
    make -j$(nproc) && \
    make install && \
    echo "âœ… ç¼–è¯‘å®‰è£…å®Œæˆ"

# æ¸…ç†
RUN rm -rf /nginx-${NGINX_VERSION}


# ================================
# é˜¶æ®µ 2ï¼šè¿è¡Œé˜¶æ®µ - æ„å»ºè½»é‡é•œåƒ
# ================================
FROM alpine:latest

LABEL maintainer="dev@example.com"
LABEL description="Nginx 1.26.2 with stream module, minimal & secure"

# ä½¿ç”¨é˜¿é‡Œäº‘æº
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    libgcc \
    openssl \
    ca-certificates

# åˆ›å»º Nginx ç”¨æˆ·
RUN adduser -D -s /sbin/nologin nginx

# å¤åˆ¶ç¼–è¯‘å¥½çš„ Nginx
COPY --from=builder ${PREFIX} ${PREFIX}

# æ—¥å¿—è¾“å‡ºåˆ° stdout/stderr
RUN ln -sf /dev/stdout ${PREFIX}/logs/access.log && \
    ln -sf /dev/stderr ${PREFIX}/logs/error.log

# å¤åˆ¶é»˜è®¤é…ç½®
RUN mkdir -p /etc/nginx && \
    cp -r ${PREFIX}/conf/* /etc/nginx/ && \
    mkdir -p /etc/nginx/conf.d

# æš´éœ²ç«¯å£
EXPOSE 80 443 3306 6379

# æŒ‚è½½ç‚¹
VOLUME ["/etc/nginx", "/usr/local/nginx/html", "/usr/local/nginx/logs"]

# ä½¿ç”¨é root ç”¨æˆ·
USER nginx

# å¯åŠ¨å‘½ä»¤
CMD ["/usr/local/nginx/sbin/nginx", "-g", "daemon off;"]
