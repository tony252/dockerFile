# ================================
# é˜¶æ®µ 1ï¼šæ„å»ºé˜¶æ®µ - ç¼–è¯‘ Nginxï¼ˆå¯ç”¨ stream æ¨¡å—ï¼‰
# ================================
FROM alpine:latest AS builder

# è®¾ç½®ç‰ˆæœ¬å˜é‡
ENV NGINX_VERSION=1.26.2 \
    PREFIX=/usr/local/nginx

# æ›´æ¢ä¸ºé˜¿é‡Œäº‘é•œåƒæºï¼ˆè§£å†³å›½å†…ç½‘ç»œé—®é¢˜ï¼‰
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆåŒ…å« linux-headersï¼‰
RUN apk add --no-cache \
    gcc \
    g++ \
    make \
    autoconf \
    libc-dev \
    linux-headers \
    pcre-dev \
    zlib-dev \
    openssl-dev \
    wget \
    tar

# ä¸‹è½½å¹¶è§£å‹ Nginx æºç 
RUN echo "ğŸ“¥ ä¸‹è½½ Nginx ${NGINX_VERSION}..." && \
    wget -q https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz && \
    echo "ğŸ“¦ è§£å‹ä¸­..." && \
    tar -xzf nginx-${NGINX_VERSION}.tar.gz --no-same-permissions -C / && \
    rm -f nginx-${NGINX_VERSION}.tar.gz

# é…ç½®å¹¶ç¼–è¯‘ Nginx
RUN echo "âš™ï¸  é…ç½® Nginx..." && \
    cd /nginx-${NGINX_VERSION} && \
    ./configure \
        --prefix=${PREFIX} \
        --with-stream \
        --with-stream_ssl_module \
        --with-http_ssl_module \
        --with-http_v2_module \
        --with-http_realip_module \
        --with-http_gzip_static_module \
        --with-threads \
        --with-file-aio \
        --with-compat \
    && \
    echo "âœ… é…ç½®å®Œæˆ" && \
    make -j$(nproc) && \
    make install && \
    echo "âœ… ç¼–è¯‘å®‰è£…å®Œæˆ"

# æ¸…ç†æºç 
RUN rm -rf /nginx-${NGINX_VERSION}


# ================================
# é˜¶æ®µ 2ï¼šè¿è¡Œé˜¶æ®µ - æ„å»ºè½»é‡é•œåƒ
# ================================
FROM alpine:latest

# âœ… é‡è¦ï¼šé‡æ–°å®šä¹‰ç¯å¢ƒå˜é‡ï¼ˆå¤šé˜¶æ®µæ„å»ºä¸ä¼šè‡ªåŠ¨ç»§æ‰¿ï¼‰
ENV PREFIX=/usr/local/nginx

# ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# âœ… å®‰è£…è¿è¡Œæ—¶ä¾èµ–ï¼ˆå…³é”®ï¼šåŒ…å« pcre æä¾› libpcre.so.1ï¼‰
RUN apk add --no-cache \
    libgcc \
    openssl \
    pcre \
    ca-certificates

# åˆ›å»º Nginx ç”¨æˆ·ï¼ˆé rootï¼‰
RUN adduser -D -s /sbin/nologin nginx

# å¤åˆ¶ç¼–è¯‘å¥½çš„ Nginx
COPY --from=builder ${PREFIX} ${PREFIX}

# âœ… ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
RUN mkdir -p ${PREFIX}/logs

# å°†æ—¥å¿—é‡å®šå‘åˆ° stdout/stderrï¼ˆä¾¿äº docker logs æŸ¥çœ‹ï¼‰
RUN ln -sf /dev/stdout ${PREFIX}/logs/access.log && \
    ln -sf /dev/stderr ${PREFIX}/logs/error.log

# åˆ›å»ºé…ç½®ç›®å½•å¹¶å¤åˆ¶é»˜è®¤é…ç½®
RUN mkdir -p /etc/nginx && \
    cp -r ${PREFIX}/conf/* /etc/nginx/ && \
    mkdir -p /etc/nginx/conf.d

# æš´éœ²å¸¸ç”¨ç«¯å£
EXPOSE 80 443 3306 6379

# æŒ‚è½½ç‚¹ï¼ˆä¾¿äºå¤–éƒ¨ç®¡ç†é…ç½®ã€é™æ€æ–‡ä»¶ã€æ—¥å¿—ï¼‰
VOLUME ["/etc/nginx", "/usr/local/nginx/html", "/usr/local/nginx/logs"]

# ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œ
USER nginx

# å¯åŠ¨å‘½ä»¤
CMD ["/usr/local/nginx/sbin/nginx", "-g", "daemon off;"]
